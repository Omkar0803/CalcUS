{% extends 'frontend/base.html' %}

{% load i18n %}

{% load static %}


{% block extrahead %}
	<title>CalcUS - Launch</title>
	<link rel="stylesheet" href="{% static 'frontend/ChemDoodleWeb.css' %}" type="text/css">
	<link rel="stylesheet" href="{% static 'frontend/uis/jquery-ui-1.11.4.css' %}" type="text/css">
	<style>
	.pick_bs_div {
		display: none;
  		position: fixed; 
  		padding-top: 50px;
  		left: 0; 
  		top: 0;
  		width: 100%;
  		height: 100%; 
  		background-color: rgb(0, 0, 0);
  		background-color: rgba(0, 0, 0, 0.5);
	}
	.modal-card {
		max-width: 850px;
		width: 100%;
	}

	.button {
		margin-top: 5px;
		margin-bottom: 5px;
	}
	.constraint_btn {
		margin-top: 0;
		margin-bottom: 0;
		width: 40px;
		height: 40px;
	}
	.close_btn {
		float: right; 
		color: lightgray; 
		font-size: 24px;  
		font-weight: bold;
	}
	.close_btn:hover {
		color: darkgray;
	}
	#calc_charge, #calc_multiplicity {
		width: 50px;
	}
	#form_error_msg {
		font-weight: bold;
		color: red;
	}
	.file-name {
		max-width: 100%;
		width: 100%;
	}
	.file-label  {
		width: 100%;
	}
	#calc_combine_files {
		margin: auto 0;
	}
	.check_msg {
		color: red;
		font-size: 10pt;
		padding-left: 5px;
	}

	@-webkit-keyframes animatetop {
		from {top:-300px; opacity:0} 
		to {top:0; opacity:1}
	}
	@keyframes animatetop {
		from {top:-300px; opacity:0}
		to {top:0; opacity:1}
	}
	</style>

	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<script type="text/javascript" src="{% static 'frontend/ChemDoodleWeb.js' %}"></script>
	<script type="text/javascript" src="{% static 'frontend/uis/ChemDoodleWeb-uis.js' %}"></script>

	<script>
	function debounce(callback, wait) {
		let timeout;
		return (...args) => {
			const context = this;
			clearTimeout(timeout);
			timeout = setTimeout(() => callback.apply(context, args), wait);
		};
	}

	/* Sets atomic labels as the atomic numbers in the xyz structure */
	(function(ChemDoodle) {
		ChemDoodle.relabel = function(molecule){
	    		for(let i = 0, ii = molecule.atoms.length; i<ii; i++){
	    			molecule.atoms[i].altLabel = String(i+1);
	    		}
	  	};
	})(ChemDoodle);

	let constraint_num = 0;
	String.prototype.format = function() {
  		a = this;
		for (i=0; i < 30; i++) {
    			a = a.replace("{}", arguments[0])
		}
  		return a
	}
	</script>
	<script>
		function check(param) {
			val = $("#calc_" + param).val();
			data = {};
			data[param] = val;
			data['software'] = $("#calc_software").val();
			$.ajax({
				method: "POST",	 	 
				url: "/check_" + param + "/",
				data: data,
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},
				success: function(msg) {
					is_red = $("#calc_" + param).hasClass("is-danger");
					if(msg == "" && is_red) {
						$("#calc_" + param).removeClass("is-danger");
					}
					else if(msg != "" && !is_red){
						$("#calc_" + param).addClass("is-danger");
					}
					$("#" + param + "_check_msg").html(msg);
				},
			});

		}
		var project_presets = {
			{% for proj in profile.project_set.all %}
			'{{ proj.name }}': {% if proj.preset %}{{ proj.preset.id }} {% else %} -1 {% endif %},
			{% endfor %}
		}

		function verify_form() {
			$("#submit_button").addClass("is-loading");
			
			//Adding the selected Project to localStorage on pressing Submit Button
			choice = document.getElementById("calc_project");
			localStorage.setItem("lastSelectedProject", choice.value);

			data = $("#calcform").serializeArray(),

			data.push({"name": "constraint_num", "value": constraint_num});

			{% if ensemble or structures %}
			data.push({"name": "starting_ensemble", "value": {{ ensemble.id }}});
			{% endif %}

			{% if structures %}
			data.push({"name": "starting_structs", "value": "{{ structures }}"});
			{% endif %}

			{% if calc %}
			data.push({"name": "starting_calc", "value": {{ calc.id }}});
			data.push({"name": "starting_frame", "value": {{ frame_num }}});
			{% endif %}

			{% if not ensemble and not structure and not calc %}
			if (sketcher.molecules.length > 0) {
				let mol = ChemDoodle.writeMOL(sketcher.getMolecule());
				data.push({"name": "structure", "value": mol});
			}
			{% endif %}

			upload_el = $("#file_structure");
			if(upload_el.length != 0) {
				num_files = upload_el[0].files.length;
			}
			else {
				num_files = 0;
			}
			data.push({"name": "num_files", "value": num_files});

			upload_aux_el = $("#aux_file_structure");
			if(upload_aux_el.length != 0) {
				num_aux_files = upload_aux_el[0].files.length;
			}
			else {
				num_aux_files = 0;
			}
			data.push({"name": "num_aux_files", "value": num_aux_files});

			$.ajax({
				data: data, 
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				type: "POST", 
				url: "/verify_calculation/",
				success: function (response) { 
					$("#calcform").submit();
					$("#form_error_msg").html("");
				},
				error: function (response) {
					$("#form_error_msg").html("Could not submit the calculation: " + response.responseText);
					$("#submit_button").removeClass("is-loading");
				}
			});

		}
		function load_preset(id) {
			$.ajax({
				method: "POST",	 	 
				url: "/load_preset/" + id,
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},
				success: function(data) {
					eval(data);
					refresh_availabilities();
					check("functional");
					check("basis_set");
					check("solvent");
				},
			});
		}

		{% if ensemble and not structures %}
			function filter_changed() {
				choice = document.getElementById("calc_filter");
				value_input = document.getElementById("calc_filter_value");
				param_input = document.getElementById("calc_filter_params");
				label = document.getElementById("filter_label");
				if(choice.value == "None") {
					value_input.style.display = "none";
					param_input.style.display = "none";
				}
				else if(choice.value == "By Boltzmann Weight") {
					value_input.style.display = "block";
					param_input.style.display = "block";
					label.innerHTML = "Higher than";
				}
				else if(choice.value == "By Relative Energy") {
					value_input.style.display = "block";
					param_input.style.display = "block";
					label.innerHTML = "Lower than (" + "{{ profile.pref_units_name }}" + ")";
				}
			}

		{% endif %}

		function calc_selection_changed() {
			choice = document.getElementById("calc_type");
			if(choice.value == "Constrained Optimisation" || choice.value == "Constrained Conformational Search") {
				editor.styles.atoms_displayLabels_3D = true;
			}
			else if(choice.value == "Minimum Energy Path") {
				editor.styles.atoms_displayLabels_3D = false;
				refresh_aux_mol();
			}
			else {
				editor.styles.atoms_displayLabels_3D = false;
			}
			set_visibility_name();
			refresh_availabilities();
		}
		
		function set_visibility_name() {
			choice = document.getElementById("calc_type");
			field = document.getElementById("calc_name_field");
			if(ensemble == true) {
				if(choice.value == "Geometrical Optimisation" ||  choice.value == "Constrained Optimisation" || choice.value == "Conformational Search" ||  choice.value == "TS Optimisation" || choice.value == "Constrained Conformational Search" || choice.value == "Minimum Energy Path") {
					field.style.display = "block";
				}
				else {
					field.style.display = "none";
				}
			}
			else {
				field.style.display = "block";

			}

		}


		function constraint_type_selection_changed(id) {
			choice = document.getElementById("constraint_type_{}".format(id));
			inp2 = document.getElementById("calc_constraint_{}_2".format(id));
			inp3 = document.getElementById("calc_constraint_{}_3".format(id));
			inp4 = document.getElementById("calc_constraint_{}_4".format(id));
			from = document.getElementById("calc_label_from_{}".format(id));
			to = document.getElementById("calc_label_to_{}".format(id));

			if (choice.value == "Distance") {
				inp2.style.display = "block";	
				inp3.style.display = "none";	
				inp4.style.display = "none";	
				from.innerHTML = "From (Å)";
				to.innerHTML = "To (Å)";
			}
			else if (choice.value == "Angle") {
				inp2.style.display = "block";	
				inp3.style.display = "block";	
				inp4.style.display = "none";	
				from.innerHTML = "From (°)";
				to.innerHTML = "To (°)";
			}
			else {
				inp2.style.display = "block";	
				inp3.style.display = "block";	
				inp4.style.display = "block";	
				from.innerHTML = "From (°)";
				to.innerHTML = "To (°)";
			}
		}

		function constraint_mode_changed(id) {
			choice = document.getElementById("constraint_mode_{}".format(id));
			div = document.getElementById("calc_scan_div_{}".format(id));
			if (choice.value == "Freeze") {
				div.style.display = "none";	
			}
			else if (choice.value == "Scan") {
				div.style.display = "block";	
			}
			refresh_availabilities();
		}

		function project_selection_changed(choice) {
			field = document.getElementById("new_project_name_field");
			if(choice.value == "New Project") {
				field.style.display = "block";
			}
			else {
				field.style.display = "none";	
				if(project_presets[choice.value] != -1) {
					load_preset(project_presets[choice.value]);
				}
				type = document.getElementById("calc_type");
				if(type.value == "Minimum Energy Path") {
					refresh_aux_mol();
				}

			}
		}

		function preselect_last_project() {
			choice = document.getElementById("calc_project");
			for(var i=0;i<choice.options.length;i++)
			{
				option = choice.options[i];
				if(option.text == localStorage.getItem("lastSelectedProject") && option.text != "New Project")
				{
					option.setAttribute('selected', true);
					project_selection_changed(option);
					return;
				}
			}
		}

		function refresh_availabilities() {

			full_options = document.querySelectorAll(".unavailable");
			full_options.forEach(element => {
				element.classList.remove("unavailable");
				element.style.display = 'block';
			});

			full_options = document.querySelectorAll(".resource_specific");
			choice = document.getElementById("calc_resource");

			full_options.forEach(element => {
				if((element.classList.contains('avail_local') && choice.value != "Local") || (element.classList.contains('avail_remote') && choice.value == "Local")) {
					element.style.display = 'none';
					element.classList.add("unavailable");
				}
			});

			set_availables();

			full_options = document.querySelectorAll(".software_specific");
			choice = document.getElementById("calc_software");

			full_options.forEach(element => {
				if(!element.classList.contains('avail_' + choice.value)) {
					element.style.display = 'none';
					element.classList.add("unavailable");
				}
			});

			set_availables();

			choice = document.getElementById("calc_solvation_model");

			full_options = document.querySelectorAll(".solvation_model_specific:not(unavailable)");

			full_options.forEach(element => {
				if(!element.classList.contains('avail_' + choice.value)) {
					element.style.display = 'none';
					element.classList.add("unavailable");
				}
			});

			set_availables();

			choice = document.getElementById("calc_theory_level");

			full_options = document.querySelectorAll(".method_specific:not(unavailable)");

			full_options.forEach(element => {
				if(!element.classList.contains('avail_' + choice.value)) {
					element.style.display = 'none';
					element.classList.add("unavailable");
				}
			});

			set_availables();

			if(choice.value == "HF"){
				hf3c = document.getElementById("hf3c").checked;
				software = document.getElementById("calc_software").value;
				if (hf3c == true && software == "ORCA") {
					document.getElementById("calc_basis_set_field").style.display = "none";
					document.getElementById("custom_bs_field").style.display = "none";
				}
				else {
					document.getElementById("calc_basis_set_field").style.display = "block";
					document.getElementById("custom_bs_field").style.display = "block";
				}
			}
			else if(choice.value == "DFT") {
				pbeh3c = document.getElementById("pbeh3c").checked;
				software = document.getElementById("calc_software").value;
				if (pbeh3c == true && software == "ORCA") {
					document.getElementById("calc_basis_set_field").style.display = "none";
					document.getElementById("calc_functional_field").style.display = "none";
					document.getElementById("custom_bs_field").style.display = "none";
				}
				else {
					document.getElementById("calc_basis_set_field").style.display = "block";
					document.getElementById("calc_functional_field").style.display = "block";
					document.getElementById("custom_bs_field").style.display = "block";
				}
			}

			set_availables();

			solvent = document.getElementById("calc_solvent").value;
			if(solvent.toLowerCase() == "vacuum" || solvent.trim() == "") {
				document.getElementById("calc_solvation_model_field").style.display = "none";
				document.getElementById("calc_solvation_radii_field").style.display = "none";
			}
			else {
				document.getElementById("calc_solvation_model_field").style.display = "block";
				radii_field = document.getElementById("calc_solvation_radii_field");
				if(radii_field.querySelectorAll("option:not(.unavailable)").length > 0) {
					radii_field.style.display = "block";
				}
			}


			choice = document.getElementById("calc_type");

			full_options = document.querySelectorAll(".type_specific:not(unavailable)");

			full_options.forEach(element => {
				if(!element.classList.contains('avail_' + choice.value.replace(/ /g, '_'))) {
					element.style.display = 'none';
					element.classList.add("unavailable");
				}

			});

			full_options = document.querySelectorAll(".type_exclusion:not(unavailable)");

			full_options.forEach(element => {
				if(element.classList.contains('not_avail_' + choice.value.replace(/ /g, '_'))) {
					element.style.display = 'none';
					element.classList.add("unavailable");
				}

			});

			set_availables();

			check("functional");
			check("basis_set");
			check("solvent");
		}

		function set_availables() {
			[].forEach.call(document.getElementById("parameters_column").querySelectorAll('select'), function(sel) {
				ind = sel.selectedIndex;
				if(ind != -1) {
					opt = sel.options[ind];
					if(opt.style.display != "none") {
						return;
					}
				}

				for(i=0; i < sel.options.length; i++) {
					opt = sel.options[i];
					if(opt.style.display != "none") {
						sel.selectedIndex = i;
					}
				}
			});
		}

		function add_constraint(first) {
			constraint_num += 1;

			_line = `
			<div class="control" id="constraint_{}"> \
				<div class="columns"> \
					<div class="column"> \
						<div class="select"> \
							<select name="constraint_mode_{}" id="constraint_mode_{}" onchange="constraint_mode_changed({})"> \
							<option>Freeze</option> \
							<option>Scan</option> \
							</select> \
						</div> \
					</div> \
					<div class="column"> \
						<div class="select"> \
				<select name="constraint_type_{}" id="constraint_type_{}" onchange="constraint_type_selection_changed({});"> \
							<option>Distance</option> \
							<option>Angle</option> \
							<option>Dihedral</option> \
							</select> \
						</div> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{}_1" id="calc_constraint_{}_1"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{}_2" id="calc_constraint_{}_2"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{}_3" id="calc_constraint_{}_3" style="display: none;"> \
					</div> \
					<div class="column"> \
						<input class="input" type="text" width="5" name="calc_constraint_{}_4" id="calc_constraint_{}_4" style="display: none;"> \
					</div> \
					<div class="column"> \
				<button type="button" class="button is-danger constraint_btn" onclick="$('#calc_scan_div_{}').remove(); $(this).parent().parent().parent().remove();">-</button> \
					</div> \
				</div> \
			</div> \
				<div style="display: none;" id="calc_scan_div_{}"> \
				<div class="columns"> \
				<div class="column"> \
					<p id="calc_label_from_{}"> From (Å)</p> \
				<input class="input software_specific avail_xtb avail_ORCA scan_from" type="text" width="5" name="calc_scan_{}_1" id="calc_scan_{}_1"> \
				</div> \
				<div class="column"> \
					<p id="calc_label_to_{}"> To (Å)</p> \
				<input class="input" type="text" width="5" name="calc_scan_{}_2" id="calc_scan_{}_2"> \
				</div> \
				<div class="column"> \
					# Steps \
				<input class="input" type="text" width="5" name="calc_scan_{}_3" id="calc_scan_{}_3"> \
				</div> \
			</div> \
			</div>`.format(constraint_num);
			if(first) {
				_line = _line.replace(`<button type="button" class="button is-danger constraint_btn" onclick="$('#calc_scan_div_{}').remove(); $(this).parent().parent().parent().remove();">-</button>`.format(constraint_num), `<button type="button" class="button is-primary constraint_btn" id="add_constraint_btn" onclick="add_constraint();">+</button>`);
			}

			$("#constraint_list").append(_line);
		}
		
		function get_3D() {
			let mol = ChemDoodle.writeMOL(sketcher.getMolecule());

			$.ajax({
				method: "POST",	 	 
				url: "/gen_3D/",
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				data: {'mol': mol},
				statusCode: {
					404: function(data) {
						$("#3d_msg").html("Error while generating structure");
					},
					200: function(data) {
						$("#3d_msg").html("");
						let mol_read = ChemDoodle.readXYZ(data);
						ChemDoodle.relabel(mol_read);
						editor.loadMolecule(mol_read);	
					}
				}
			});
		}
		

		function add_file_name() {
			path = $("#file_structure").val();
			file_name = path.replace('C:\\fakepath\\', '').split('.')[0];
			curr_name = document.getElementById("calc_mol_name").value;
			if(curr_name == "") {
				$("#calc_mol_name").val(file_name);
			}
		}

		function toggle_visibility_molname(check) {
			if(check.checked) {
				$("#calc_mol_name_field").hide();
			}
			else{
				$("#calc_mol_name_field").show();
			}
		}

		function preview_upload(file_list) {
			if(file_list.length == 1 && file_list[0].type == "chemical/x-xyz") {
				var reader = new FileReader();
				reader.readAsText(file_list[0], "UTF-8");
				reader.onload = function(e) {
					let mol_read = ChemDoodle.readXYZ(e.target.result);
					ChemDoodle.relabel(mol_read);
					editor.loadMolecule(mol_read);	
				}
			}
			else if(file_list.length == 1 && file_list[0].type == "chemical/x-mdl-molfile") {
				var reader = new FileReader();
				reader.readAsText(file_list[0], "UTF-8");
				reader.onload = function(e) {
					let mol_read = ChemDoodle.readMOL(e.target.result, multiplier=1);
					ChemDoodle.relabel(mol_read);
					editor.loadMolecule(mol_read);	
				}

			}


		}

		function file_upload_changed() {
  			file_list = this.files;
			add_file_name();	
			preview_upload(file_list);

			ff = file_list[0].name;
			fname = ff.replace('C:\\fakepath\\', '');
			if(file_list.length > 1) {
				fname += ', ...';
			}

			$("#file_upload_name").html(fname);

			combine = document.getElementById("calc_combine_files_column");
			parse  = document.getElementById("calc_parse_filenames_column");
			if (file_list.length > 1) {
				combine.style.display = "block";	
				parse.style.display = "block";	
			}
			else {
				combine.style.display = "none";	
				parse.style.display = "none";	
			}
		}

		function set_project_default() {
			$.ajax({
				data: $("#calcform").serialize(), 
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				type: "POST", 
				url: "/set_project_default/",
				success: function (response) { 
					$("#preset_msg").html(response);
					refresh_presets();
				}
			});
		}
		
		function save_preset() {
			preset_name = prompt("Name of the preset?", "")
			if(preset_name != null) {
				data = $("#calcform").serializeArray();
				data.push({ name: 'preset_name', value: preset_name});
				$.ajax({
					data: data, 
					headers: {
						"X-CSRFToken": '{{ csrf_token }}',
					},

					type: "POST", 
					url: "/save_preset/",
					success: function (response) { 
						$("#preset_msg").html(response);
						refresh_presets();
					}
				});
			}

		}
		
		function load_selected_preset() {
			preset = document.getElementById("presets").value;
			load_preset(preset);
		}
		function delete_preset() {
			preset = document.getElementById("presets").value;
			$.ajax({
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				type: "POST", 
				url: "/delete_preset/" + preset,
				success: function (response) { 
					$("#preset_msg").html(response);
					refresh_presets();
				}
			});
	
		}

		function refresh_presets() {
			$("#presets").load("/presets/");
		}
		function refresh_aux_mol() {
			proj = document.getElementById("calc_project");
			$.ajax({
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				type: "POST", 
				data: {
					'proj': proj.value,
				},
				url: "/aux_molecule/",
				success: function (response) { 
					$("#aux_mol").html(response);
					refresh_aux_ensemble();	
				}
			});
		}
		function refresh_aux_ensemble() {
			aux_mol = document.getElementById("aux_mol");
			$.ajax({
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				type: "POST", 
				data: {
					'mol_id': aux_mol.value,
				},
				url: "/aux_ensemble/",
				success: function (response) { 
					$("#aux_ensemble").html(response);
					refresh_aux_structure();	
				}
			});
		}
		function refresh_aux_structure() {
			aux_mol = document.getElementById("aux_ensemble");
			$.ajax({
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				type: "POST", 
				data: {
					'e_id': aux_ensemble.value,
				},
				url: "/aux_structure/",
				success: function (response) { 
					$("#aux_struct").html(response);
				}
			});
			
		}
		{% if ensemble or structure %}
		let ensemble = true;
		{% else %}
		let ensemble = false;
		{% endif %}
	</script>
{% endblock %}

{% block content %}

{% csrf_token %}
	<datalist id="basis_sets_options">
		<option value="6-31+G(d,p)">6-31+G(d,p)</option>
		<option value="Def2SVP">Def2SVP</option>
		<option value="Def2TZVP">Def2TZVP</option>
		<option value="aug-cc-pVDZ">aug-cc-pVDZ</option>
		<option value="aug-cc-pVTZ">aug-cc-pVTZ</option>
	</datalist>
	<datalist id="functional_options">
		<option value="M06">M06</option>
		<option value="M062X">M062X</option>
		<option value="PBE0">PBE0</option>
		<option value="B3LYP">B3LYP</option>
		<option value="wB97XD">wB97XD</option>
	</datalist>
	<datalist id="solvent_options">
		<option value="Acetone">Acetone</option>
		<option value="Acetonitrile">Acetonitrile</option>
		<option value="Chloroform">Chloroform</option>
		<option value="Dichloromethane">Dichloromethane</option>
		<option value="Dimethylsulfoxide">Dimethylsulfoxide</option>
		<option value="Hexane">Hexane</option>
		<option value="Methanol">Methanol</option>
		<option value="Toluene">Toluene</option>
		<option value="Vacuum">Vacuum</option>
		<option value="Water">Water</option>
	</datalist>


	<div class="columns is-desktop">
		<div class="column">
			{% if not ensemble and not structure and not calc %}
			<script>
				let sketcher = new ChemDoodle.SketcherCanvas('sketcher', 400, 300, {useServices:false, oneMolecule:false});
				sketcher.styles.atoms_usePYMOLColors = true;
				sketcher.oneMolecule = false;
				sketcher.styles.bonds_clearOverlaps_2D = true;
				sketcher.styles.shapes_color = 'c10000';
				sketcher.repaint();
			</script>
			<br />
			<button class="button" onclick="get_3D();">Generate 3D representation</button>
			{% endif %}

			<script>
				let editor = new ChemDoodle.EditorCanvas3D('editor', 400, 300, {useServices:false, oneMolecule:false});
				editor.styles.atoms_usePYMOLColors = true;
				editor.oneMolecule = false;
				editor.styles.set3DRepresentation('Stick');
				editor.styles.shapes_color = 'c10000';
				editor.repaint();
			</script>
			<div id="3d_msg">
			</div>

		</div>
		<div class="column" id="parameters_column">
			<div class="column" >
				<div class="box">
					<center>
						<div class="select">
							<select id="presets">
							</select>
						</div>
						<br />
						<a class="button is-info" onclick="load_selected_preset()">Load Preset</a>
						<a class="button is-info" onclick="save_preset()">Save Preset</a>
						<a class="button is-danger" onclick="delete_preset()">Delete Preset</a>
						<br />
						<a class="button is-info" onclick="set_project_default()">Set current parameters as project defaults</a>
						<div id="preset_msg">

						</div>
					</center>
				</div>
			</div>

			<form action="/submit_calculation/" method="post" id="calcform" enctype="multipart/form-data">

				{% if not ensemble and not structure %}

				<div class="columns">
					<div class="column">
						<div class="field">
							<label class="label">Draw a structure or choose a file</label>
							<div class="file has-name">
								<label class="file-label">
									<input class="file-input" type="file" name="file_structure" id="file_structure" multiple="multiple">
									<span class="file-cta">
										<span class="file-icon">
											<i class="fas fa-upload"></i>
										</span>
										<span class="file-label">
										File upload
										</span>
									</span>
									<span class="file-name" id="file_upload_name">
									No input file selected
									</span>
								</label>
							</div>
						</div>
					</div>
					<div class="column is-narrow has-text-centered" id="calc_parse_filenames_column" style="display: none;">
						<label class="label">Use filename(s)</label>
						<div class="control">
							<input type="checkbox" class="checkbox" id="calc_parse_filenames" name="calc_parse_filenames" onchange="toggle_visibility_molname(this);">
						</div>
					</div>

					<div class="column is-narrow has-text-centered" id="calc_combine_files_column" style="display: none;">
						<label class="label">Single ensemble</label>
						<div class="control">
							<input type="checkbox" class="checkbox" id="calc_combine_files" name="calc_combine_files">
						</div>
					</div>
				</div>

				<div class="field type_specific avail_Minimum_Energy_Path" style="display: none;">
					<div class="file">
						<label class="file-label">
							<input class="file-input" type="file" name="aux_file_structure" id="aux_file_structure">
								<span class="file-cta">
								<span class="file-icon">
									<i class="fas fa-upload"></i>
								</span>
								<span class="file-label">
								Upload auxiliary structure
								</span>
							</span>
						</label>
					</div>
				</div>

				{% endif %}
				{% csrf_token %}

				<div class="columns">
					<div class="column">
						{% if not calc and not ensemble and not structure %}
						<div class="field" id="calc_mol_name_field">
							<label class="label">Molecule Name</label>
							<div class="control">
								<input class="input" name="calc_mol_name" id="calc_mol_name" type="text">
							</div>
						</div>
						{% endif %}
						<div class="field" id="calc_name_field">
							<label class="label">Ensemble Name</label>
							<div class="control">
								<input class="input" name="calc_name" id="calc_name" type="text" placeholder="(Optional)">
							</div>
						</div>
					</div>

					<div class="column is-narrow">
						<div class="field">
							<label class="label">Charge</label>
							<div class="control" >
								<input class="input" name="calc_charge" id="calc_charge" type="text" value="0">
							</div>
						</div>
					</div>
					<div class="column is-narrow">
						<div class="field">
							<label class="label">Multiplicity</label>
							<div class="control" >
								<input class="input" name="calc_multiplicity" id="calc_multiplicity" type="text" value="1">
							</div>
						</div>
					</div>
				</div>
				<div class="columns">
					<div class="column is-narrow">
						<div class="field">
							<label class="label">Solvent</label>
							<div class="control">
								<input class="input" name="calc_solvent" id="calc_solvent" type="text" oninput="refresh_availabilities();" list="solvent_options">
							</div>
							<p class="check_msg is-danger" id="solvent_check_msg"></p>
						</div>
					</div>
					<div class="column is-narrow">
						<div class="field" id="calc_solvation_model_field">
							<label class="label">Solvation Model</label>
								<div class="control">
									<div class="select">
									<select name="calc_solvation_model" id="calc_solvation_model" onchange="refresh_availabilities();">
										<option class="software_specific avail_xtb type_specific avail_Constrained_Optimisation avail_Constrained_Conformational_Search avail_Geometrical_Optimisation avail_Frequency_Calculation avail_UV-Vis_Calculation avail_Single-Point_Energy avail_Conformational_Search">GBSA</option>
										<option class="software_specific avail_xtb">ALPB</option>
										<option class="software_specific avail_Gaussian avail_ORCA">SMD</option>
										<option class="software_specific avail_Gaussian">PCM</option>
										<option class="software_specific avail_Gaussian avail_ORCA">CPCM</option>
									</select>
									</div>
								</div>
						</div>
					</div>
					<div class="column is-narrow">
						<div class="field software_specific avail_Gaussian avail_ORCA" id="calc_solvation_radii_field">
							<label class="label">Solvation Radii</label>
							<div class="control">
								<div class="select">
									<select name="calc_solvation_radii" id="calc_solvation_radii">
										<option class="solvation_model_specific avail_SMD">SMD18</option>
									    	<option class="solvation_model_specific avail_SMD">Default</option>
									    	<option class="solvation_model_specific avail_PCM avail_CPCM">UFF</option>
									    	<option class="solvation_model_specific avail_PCM avail_CPCM">UA0</option>
									    	<option class="solvation_model_specific avail_PCM avail_CPCM">UAHF</option>
									    	<option class="solvation_model_specific avail_PCM avail_CPCM">UAKS</option>
									    	<option class="solvation_model_specific avail_PCM avail_CPCM">Pauling</option>
									    	<option class="solvation_model_specific avail_PCM avail_CPCM">Bondi</option>
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="columns">
					<div class="column is-narrow">
						<div class="field">
							<label class="label">Project</label>
							<div class="control">
								<div class="select" >
								  <select name="calc_project" onchange="project_selection_changed(this)" id="calc_project">
									  {% for proj in profile.project_set.all|dictsort:"name" %}
									  <option name="{{ proj }}">{{ proj }}</option>
									  {% endfor %}
									  <option name="new_project">New Project</option>
								  </select>
								</div>
							</div>
						</div>

					</div>
					<div class="column">
						<div class="field" style="display: none;" id="new_project_name_field">
							<label class="label">Name of new project</label>
							<div class="control">
								<input class="input" name="new_project_name" type="text" placeholder="My Project">
							</div>
						</div>
					</div>

				</div>

				<div class="field">
					<label class="label">Software</label>
					<div class="control" >
						<div class="select">
							<select name="calc_software" id="calc_software" onchange="refresh_availabilities();">
								<option {% if 'xtb' not in packages %}class="resource_specific avail_remote"{% endif %}>xtb</option>
								<option {% if 'ORCA' not in packages %}class="resource_specific avail_remote"{% endif %}>ORCA</option>
								<option {% if 'Gaussian' not in packages %}class="resource_specific avail_remote"{% endif %}>Gaussian</option>
							</select>
						</div>
					</div>
				</div>

				<div class="field">
					<label class="label">Calculation Type</label>
					<div class="control" >
						<div class="select">
							<select name="calc_type" id="calc_type" onchange="calc_selection_changed();">
							{% for proc in procs %}
							<option class="software_specific {% if proc.avail_xtb %}avail_xtb{% endif %} {% if proc.avail_ORCA %}avail_ORCA{% endif %} {% if proc.avail_Gaussian %}avail_Gaussian{% endif %}">{{ proc.name }}</option>
							{% endfor %}
							</select>
						</div>
					</div>
				</div>
				<div class="type_specific avail_Minimum_Energy_Path" id="aux_structure_div">
					<div class="field">
						<label class="label">Existing auxiliary structure</label>
						<div class="control" id="aux_structure">
							<div class="columns">
								<div class="column">
									<label class="label">Molecule</label>
									<div class="select" id="aux_mol_select">
										<select name="aux_mol" id="aux_mol" onchange="refresh_aux_ensemble();">
										</select>
									</div>
								</div>
								<div class="column">
									<label class="label">Ensemble</label>
									<div class="select">
										<select name="aux_ensemble" id="aux_ensemble" onchange="refresh_aux_structure();">
										</select>
									</div>
								</div>
								<div class="column">
									<label class="label">Structure</label>
									<div class="select">
										<select name="aux_struct" id="aux_struct">
										</select>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div style="display: none;" class="type_specific avail_Constrained_Optimisation avail_Constrained_Conformational_Search" id="constraint_div">
					<div class="field">
						<label class="label">Constraints and scan coordinates</label>
						<div id="constraint_list">
						</div>
					</div>
				</div>

				<div class="software_specific avail_ORCA avail_Gaussian">
					<div class="field">
						<label class="label">Theory Level</label>
						<div class="control" >
							<div class="select">
								<select name="calc_theory_level" id="calc_theory_level" onchange="refresh_availabilities();">
									<option class="type_exclusion not_avail_UV-Vis_Calculation">Semi-empirical</option>
									<option>HF</option>
									<option>DFT</option>
									<option class="software_specific avail_ORCA">RI-MP2</option>
								</select>
							</div>
						</div>
					</div>
					<div class="columns">
						<div class="method_specific avail_DFT">
							<div class="column is-narrow software_specific avail_ORCA ">
								<div class="field">
									<label class="label">Special</label>
									<label class="checkbox">
										<input type="checkbox" name="pbeh3c" id="pbeh3c" onchange="refresh_availabilities();">
										PBEh-3c
									</label>		
								</div>
							</div>
						</div>
						<div class="method_specific avail_HF">
							<div class="column is-narrow software_specific avail_ORCA ">
								<div class="field">
									<label class="label">Special</label>
									<label class="checkbox">
										<input type="checkbox" id="hf3c" name="hf3c" onchange="refresh_availabilities();">
										HF-3c
									</label>		
								</div>
							</div>
						</div>
						<div class="column method_specific avail_Semi-empirical">
							<div class="field">
								<label class="label">Method</label>
								<div class="control">
									<div class="select">
										<select name="calc_se_method" id="calc_method">
											<option>AM1</option>
											<option>PM3</option>
											<option class="software_specific avail_Gaussian">PM6</option>
											<option class="software_specific avail_Gaussian">PM7</option>
										</select>
									</div>
								</div>
							</div>
						</div>


						<div class="column method_specific avail_DFT">
							<div class="field" id="calc_functional_field">
								<label class="label">Functional</label>
								<div class="control">
									<input class="input" name="calc_functional" id="calc_functional" type="text" list="functional_options">
								</div>
								<p class="check_msg is-danger" id="functional_check_msg"></p>
							</div>
						</div>
						<div class="column method_specific avail_DFT avail_RI-MP2 avail_HF">
							<div class="field" id="calc_basis_set_field">
								<label class="label">Basis set</label>
								<div class="control">
									<input class="input" name="calc_basis_set" id="calc_basis_set" type="text" list="basis_sets_options">
								</div>
								<p class="check_msg is-danger" id="basis_set_check_msg"></p>
							</div>
						</div>

					</div>
				</div>
				<br />
				<div>
						<div>
							<div class="field" id="custom_specifications_field">
								<label class="label">Specifications</label>
								<div class="control">
									<input class="input" name="calc_specifications" id="calc_specifications" type="text" placeholder="" >
								</div>
							</div>
						</div>
						<div class="method_specific avail_DFT">
							<div class="field software_specific avail_Gaussian">
								<label class="label">Density Fitting</label>
								<div class="control">
									<input class="input" name="calc_df" id="calc_df" type="text" placeholder="" >
								</div>
							</div>
						</div>
						<div class="method_specific avail_DFT avail_RI-MP2 avail_HF">
							<div class="field" id="custom_bs_field">
								<label class="label">Custom basis sets</label>
								<div class="control">
									<input class="input" name="calc_custom_bs" id="calc_custom_bs" type="text" placeholder="" >
								<button class="button is-info" id="pick_bs_button" type="button">Pick custom basis sets</button>
								</div>
							</div>

							<div class="modal pick_bs_div" id="pick_bs_div">
								<div class="modal-card">
									<header class="modal-card-head">
										<p class="modal-card-title">Specific basis sets</p>
										<button type="button" class="close_btn close_bs modal-close is-large" aria-label="close"></button>
									</header>
									<section class="modal-card-body" id="custom_bs_body">
									</section>
								</div>
							</div>
						</div>
				</div>
				<br />
				<div class="field">
					<label class="label">Resource</label>
					<div class="control" >
						<div class="select">
						<select name="calc_resource" id="calc_resource" onchange="refresh_availabilities();">
							{% if allow_local_calc %}
								{% if profile.group or profile.is_PI or request.user.is_superuser %}
									<option>Local</option>
								{% endif %}
							{% endif %}
							{% for access in profile.accesses %}
								{% if access.connected %}
									<option>{{ access.cluster_address }}</option>
								{% endif %}
							{% endfor %}
						  </select>
						</div>
					</div>
				</div>

				{% if ensemble and not structures %}
					<div class="columns">
						<div class="column">
							<div class="field">
								<label class="label">Filter</label>
								<div class="control" >
									<div class="select">
									<select name="calc_filter" onchange="filter_changed();" id="calc_filter">
										<option>None</option>
										<option>By Relative Energy</option>
										<option>By Boltzmann Weight</option>
									  </select>
									</div>
								</div>
							</div>
						</div>
						<div class="column">
							<div class="field" style="display: none;" id="calc_filter_value">
								<label class="label" id="filter_label">Higher than</label>
								<div class="control">
									<input class="input" name="filter_value" type="text" id="filter_value_input">
								</div>
							</div>
						</div>
						<div class="column">
							<div class="field" id="calc_filter_params">
								<label class="label">Parameters</label>
								<div class="control" >
									<div class="select">
									<select name="filter_parameters">
										{% for p in ensemble.unique_parameters %}
											<option value="{{ p.id }}">{{ p }}</option>
										{% endfor %}
									  </select>
									</div>
								</div>
							</div>
						</div>

					</div>

				{% endif %}

				<div class="field">
					<span id="form_error_msg"></span>
					<div class="control">
						<a class="button is-primary" id="submit_button" onclick="verify_form()">Submit</a>
					</div>
				</div>
			</form>
		</div>
	</div>
	<script>
		$('#calcform').submit(function(){
			$('<input />').attr('type', 'hidden')
				.attr('name', "constraint_num")
				.attr('value', constraint_num)
				.appendTo(this);

			{% if ensemble or structures %}
			$('<input />').attr('type', 'hidden')
				.attr('name', "starting_ensemble")
				.attr('value', {{ ensemble.id }})
				.appendTo(this);
			{% endif %}

			{% if structures %}
			$('<input />').attr('type', 'hidden')
				.attr('name', "starting_structs")
				.attr('value', "{{ structures }}")
				.appendTo(this);
			{% endif %}

			{% if calc %}
			$('<input />').attr('type', 'hidden')
				.attr('name', "starting_calc")
				.attr('value', {{ calc.id }})
				.appendTo(this);
			$('<input />').attr('type', 'hidden')
				.attr('name', "starting_frame")
				.attr('value', {{ frame_num }})
				.appendTo(this);
			{% endif %}

			{% if not ensemble and not structure and not calc %}
			if (sketcher.molecules.length > 0) {
				let mol = ChemDoodle.writeMOL(sketcher.getMolecule());

				$('<input />').attr('type', 'hidden')
					.attr('name', "structure").val(mol).appendTo("#calcform");
			}
			{% endif %}

		}); 

	$( document ).ready(function() {
		{% if not ensemble and not structure %}
		preselect_last_project();
		project_selection_changed(document.getElementById("calc_project"));
		{% endif %}

		refresh_presets();

		refresh_availabilities();

		{% if proj %}
		proj = document.getElementById("calc_project");
		proj.value = "{{ proj.name }}";
		{% endif %}

		{% if init_params_id %}
			$.ajax({
				method: "POST",	 	 
				url: "/load_params/" + {{ init_params_id }},
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},
				success: function(data) {
					eval(data);
					refresh_availabilities();
					refresh_availabilities();//Whatever
					$('#calc_software').data('software', $("#calc_software").val());

				},
			});
		{% endif %}
		{% if resource %}
		resource = document.getElementById("calc_resource");
		resource.value = "{{ resource }}";
		{% endif %}
		{% if ensemble and not structure %}
			$("#calc_project").val("{{ ensemble.parent_molecule.project.name }}");
			$.ajax({
				method: "POST",	 	 
				url: "/get_structure/",
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},

				data: {'id': {{ ensemble.id }}, 'num': 1},
				success: function(data, textStatus, xhr) {
					let mol_read = ChemDoodle.readXYZ(data);
					ChemDoodle.relabel(mol_read);
					editor.loadMolecule(mol_read);	
				}
			});

		{% endif %}

		{% if structure %}
			$("#calc_project").val("{{ structure.parent_ensemble.parent_molecule.project.name }}");
			let mol_read = ChemDoodle.readXYZ(`{{ structure.xyz_structure }}`);
			ChemDoodle.relabel(mol_read);
			editor.loadMolecule(mol_read);	
		{% endif %}
		{% if calc %}
			$("#calc_project").val("{{ calc.order.project.name }}");
			$.ajax({
				method: "POST",	 	 
				url: "/get_calc_frame/{{ calc.id }}/{{ frame_num }}",
				headers: {
					"X-CSRFToken": '{{ csrf_token }}',
				},
				success: function(data) {
					let mol_read = ChemDoodle.readXYZ(data);
					ChemDoodle.relabel(mol_read);
					editor.loadMolecule(mol_read);	
					$('#calc_software').data('software', $("#calc_software").val());

				},
			});

		{% endif %}

	});
	</script>
	<script>
	let modalBtnBs = document.getElementById("pick_bs_button")
	let modalBs = document.querySelector(".pick_bs_div")
	let closeBtnBs = document.querySelector(".close_bs")
	modalBtnBs.onclick = function(){
		div = $("#custom_bs_body");
		if (div.html().replace(/^\s+|\s+$/g, '') == ""){
			$("#custom_bs_body").load("/periodictable/");
		}
  		modalBs.style.display = "block";
	}
	closeBtnBs.onclick = function(){
  		modalBs.style.display = "none";
		print_output_bs();
	}
	function print_output_bs() {
		output = document.getElementById("calc_custom_bs");
		tmp_output = document.getElementById("custom_bs");

		output.value = tmp_output.value;
	}

	window.onclick = function(e){
  		if(e.target == modalBs){
    			modalBs.style.display = "none";
			print_output_bs();
  		}
	}		

	
	$('#calc_software').change(function(e){
		var software = $(this).data('software');

		$('#calc_specifications').data(software, $('#calc_specifications').val());
		$('#calc_specifications').val($('#calc_specifications').data($(this).val()));

		$(this).data('software', $(this).val());
	})

	add_constraint(true);	

	{% if not ensemble and not structure and not calc %}
		const inputElement = document.getElementById("file_structure");
		inputElement.addEventListener("change", file_upload_changed, false);
	{% endif %}

	$("#calc_functional").keyup(debounce(function() {check("functional")}, 250));
	$("#calc_basis_set").keyup(debounce(function() {check("basis_set")}, 250));
	$("#calc_solvent").keyup(debounce(function() {check("solvent")}, 250));

	</script>

{% endblock content %}
